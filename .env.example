document.addEventListener('DOMContentLoaded', () => {
    const socket = io();

    // --- UI Elements ---
    const deviceName = document.getElementById('header-device-name');
    const albumArt = document.getElementById('album-art');
    const playerTitle = document.getElementById('player-title');
    const playerArtist = document.getElementById('player-artist');
    const playerAlbum = document.getElementById('player-album');
    const seekSlider = document.getElementById('seek-slider');
    const timeCurrent = document.getElementById('time-current');
    const timeDuration = document.getElementById('time-duration');
    const btnPrev = document.getElementById('btn-prev');
    const btnPlayPause = document.getElementById('btn-play-pause');
    const btnNext = document.getElementById('btn-next');
    const statusLight = document.getElementById('status-light');
    const statusText = document.getElementById('status-text');
    
    // Modal Elements
    const libraryModal = document.getElementById('library-modal');
    const settingsModal = document.getElementById('settings-modal');
    const queueModal = document.getElementById('queue-modal');
    const uploadModal = document.getElementById('upload-modal');
    const rebootConfirmModal = document.getElementById('reboot-confirm-modal');
    const btnOpenLibrary = document.getElementById('btn-open-library');
    const btnCloseLibrary = document.getElementById('btn-close-library');
    const btnOpenSettings = document.getElementById('btn-open-settings');
    const btnCloseSettings = document.getElementById('btn-close-settings');
    const btnOpenQueue = document.getElementById('btn-open-queue');
    const btnCloseQueue = document.getElementById('btn-close-queue');
    const btnClearQueue = document.getElementById('btn-clear-queue');
    const btnOpenUpload = document.getElementById('btn-open-upload');
    const btnCloseUpload = document.getElementById('btn-close-upload');
    const btnReboot = document.getElementById('btn-reboot');
    const btnRescan = document.getElementById('btn-rescan');
    const btnConfirmReboot = document.getElementById('btn-confirm-reboot');
    const btnCancelReboot = document.getElementById('btn-cancel-reboot');
    const btnCloseReboot = document.getElementById('btn-close-reboot-confirm');

    // Library
    const libraryViewArtists = document.getElementById('library-view-artists');
    const libraryViewAlbums = document.getElementById('library-view-albums');
    const libraryViewTracks = document.getElementById('library-view-tracks');
    const tidalViewSearch = document.getElementById('tidal-view-search');
    const librarySearch = document.getElementById('library-search');
    const sourceBtns = document.querySelectorAll('.source-btn');
    const localTabs = document.getElementById('local-tabs');
    const tidalTabs = document.getElementById('tidal-tabs');
    const libraryBackBtn = document.getElementById('library-back-btn'); // Ensure this exists in HTML if used

    // Auth Elements
    const btnTidalLogin = document.getElementById('btn-tidal-login');
    const btnTidalManual = document.getElementById('btn-tidal-manual');
    const btnTidalLogout = document.getElementById('btn-tidal-logout');
    const tidalUsername = document.getElementById('tidal-username');
    const tidalPassword = document.getElementById('tidal-password');
    const tidalSessionId = document.getElementById('tidal-session-id');
    const tidalUserId = document.getElementById('tidal-user-id');
    const tidalCountry = document.getElementById('tidal-country-code');
    const tidalLoginContainer = document.getElementById('tidal-login-container');
    const tidalConnectedInfo = document.getElementById('tidal-connected-info');
    const authTabs = document.querySelectorAll('.auth-tab');
    const authAuto = document.getElementById('auth-auto');
    const authManual = document.getElementById('auth-manual');
    
    // State
    let isSeeking = false;
    let currentSource = 'local';
    let currentLibraryView = 'artists';
    let searchTimeout;
    let playerTimer;
    let lastStatusElapsed = 0;
    let lastStatusDuration = 0;
    let lastStatusTime = 0;

    // --- Helper Functions ---
    const formatTime = (s) => {
        if (isNaN(s) || s < 0) return '0:00';
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60).toString().padStart(2, '0');
        return `${m}:${sec}`;
    };

    const openModal = (m) => { if(m) m.classList.remove('hidden'); };
    const closeModal = (m) => { if(m) m.classList.add('hidden'); };
    
    const startTimer = () => {
        clearInterval(playerTimer);
        playerTimer = setInterval(() => {
            if(isSeeking) return;
            const diff = (Date.now() - lastStatusTime) / 1000;
            const current = lastStatusElapsed + diff;
            if(current > lastStatusDuration) clearInterval(playerTimer);
            else {
                if(seekSlider) seekSlider.value = current;
                if(timeCurrent) timeCurrent.textContent = formatTime(current);
            }
        }, 500);
    };

    // --- Auth Logic ---

    // Tab Switching
    authTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            authTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            if (tab.dataset.target === 'auto') {
                if(authAuto) authAuto.classList.remove('hidden');
                if(authManual) authManual.classList.add('hidden');
            } else {
                if(authAuto) authAuto.classList.add('hidden');
                if(authManual) authManual.classList.remove('hidden');
            }
        });
    });

    // Auto Login
    if (btnTidalLogin) {
        btnTidalLogin.addEventListener('click', async () => {
            const u = tidalUsername.value.trim();
            const p = tidalPassword.value.trim();
            if (!u || !p) return alert('Enter credentials');
            
            btnTidalLogin.disabled = true;
            btnTidalLogin.textContent = 'Logging in...';
            try {
                const res = await fetch('/auth/tidal/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if (res.ok) {
                    alert('Success!');
                    socket.emit('getServices');
                    tidalUsername.value = ''; tidalPassword.value = '';
                } else alert(`Error: ${data.error}`);
            } catch(e) { alert('Network error'); }
            finally { btnTidalLogin.disabled = false; btnTidalLogin.textContent = 'Log In'; }
        });
    }

    // Manual Session
    if (btnTidalManual) {
        btnTidalManual.addEventListener('click', async () => {
            const sid = tidalSessionId.value.trim();
            const uid = tidalUserId.value.trim();
            const cc = tidalCountry.value.trim();
            if (!sid || !uid) return alert('Session ID and User ID required');
            
            btnTidalManual.disabled = true;
            try {
                const res = await fetch('/auth/tidal/session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sessionId: sid, userId: uid, countryCode: cc })
                });
                const data = await res.json();
                if (res.ok) {
                    alert('Session Saved!');
                    socket.emit('getServices');
                    tidalSessionId.value = ''; tidalUserId.value = '';
                } else alert(`Error: ${data.error}`);
            } catch(e) { alert('Network error'); }
            finally { btnTidalManual.disabled = false; }
        });
    }

    if (btnTidalLogout) btnTidalLogout.addEventListener('click', () => { if(confirm('Logout?')) socket.emit('logoutService', 'tidal'); });

    // --- Library Logic ---
    
    // Source Switch
    sourceBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            currentSource = btn.dataset.source;
            sourceBtns.forEach(b => b.classList.toggle('active', b.dataset.source === currentSource));
            
            if (currentSource === 'local') {
                localTabs.classList.remove('hidden');
                tidalTabs.classList.add('hidden');
                showLibraryView('artists');
            } else {
                localTabs.classList.add('hidden');
                tidalTabs.classList.remove('hidden');
                // Hide local views, show tidal search
                [libraryViewArtists, libraryViewAlbums, libraryViewTracks].forEach(e => e.classList.add('hidden'));
                tidalViewSearch.classList.remove('hidden');
            }
        });
    });

    const showLibraryView = (view) => {
        currentLibraryView = view;
        [libraryViewArtists, libraryViewAlbums, libraryViewTracks, tidalViewSearch].forEach(e => e && e.classList.add('hidden'));
        if (view === 'artists') libraryViewArtists.classList.remove('hidden');
        else if (view === 'albums') libraryViewAlbums.classList.remove('hidden');
        else if (view === 'tracks') libraryViewTracks.classList.remove('hidden');
    };

    const fetchTidalSearch = async (q) => {
        if(!tidalViewSearch) return;
        tidalViewSearch.innerHTML = 'Loading...';
        try {
            const res = await fetch(`/api/tidal/search?query=${encodeURIComponent(q)}`);
            const data = await res.json();
            tidalViewSearch.innerHTML = '';
            // Simple rendering of tracks for brevity
            if(data.tracks && data.tracks.items) {
                const ul = document.createElement('ul');
                ul.className = 'library-track-list';
                data.tracks.items.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'library-track';
                    li.innerHTML = `<div class="track-info"><div class="track-title">${t.title}</div><div class="track-artist">${t.artist.name}</div></div>`;
                    li.addEventListener('click', () => {
                        socket.emit('clearQueue');
                        socket.emit('addToQueue', `tidal://track/${t.id}`);
                        socket.emit('play');
                        closeModal(libraryModal);
                    });
                    ul.appendChild(li);
                });
                tidalViewSearch.appendChild(ul);
            } else {
                tidalViewSearch.innerHTML = 'No results';
            }
        } catch(e) { tidalViewSearch.innerHTML = 'Error searching'; }
    };

    if (librarySearch) {
        librarySearch.addEventListener('input', () => {
            const val = librarySearch.value.trim();
            if (currentSource === 'tidal') {
                clearTimeout(searchTimeout);
                if(val.length > 2) searchTimeout = setTimeout(() => fetchTidalSearch(val), 500);
            }
        });
    }

    // --- General Events ---
    if (btnOpenLibrary) btnOpenLibrary.addEventListener('click', () => { openModal(libraryModal); socket.emit('getArtists'); });
    if (btnCloseLibrary) btnCloseLibrary.addEventListener('click', () => closeModal(libraryModal));
    
    if (btnOpenSettings) btnOpenSettings.addEventListener('click', () => { openModal(settingsModal); socket.emit('getServices'); socket.emit('getSystemInfo'); });
    if (btnCloseSettings) btnCloseSettings.addEventListener('click', () => closeModal(settingsModal));
    
    if (btnOpenQueue) btnOpenQueue.addEventListener('click', () => { openModal(queueModal); socket.emit('getStatus'); });
    if (btnCloseQueue) btnCloseQueue.addEventListener('click', () => closeModal(queueModal));
    if (btnClearQueue) btnClearQueue.addEventListener('click', () => socket.emit('clearQueue'));

    if (btnOpenUpload) btnOpenUpload.addEventListener('click', () => openModal(uploadModal));
    if (btnCloseUpload) btnCloseUpload.addEventListener('click', () => closeModal(uploadModal));

    if (btnReboot) btnReboot.addEventListener('click', () => openModal(rebootConfirmModal));
    if (btnConfirmReboot) btnConfirmReboot.addEventListener('click', () => { socket.emit('rebootPi'); closeModal(rebootConfirmModal); });
    if (btnCancelReboot) btnCancelReboot.addEventListener('click', () => closeModal(rebootConfirmModal));
    if (btnCloseReboot) btnCloseReboot.addEventListener('click', () => closeModal(rebootConfirmModal)); // Ensure ID matches HTML

    if (btnRescan) btnRescan.addEventListener('click', () => socket.emit('rescanLibrary'));

    // Player
    if (btnPlayPause) btnPlayPause.addEventListener('click', () => {
        const isPlaying = btnPlayPause.classList.contains('playing');
        socket.emit(isPlaying ? 'pause' : 'play');
    });
    if (btnNext) btnNext.addEventListener('click', () => socket.emit('next'));
    if (btnPrev) btnPrev.addEventListener('click', () => socket.emit('previous'));
    
    if (seekSlider) {
        seekSlider.addEventListener('input', () => { isSeeking = true; });
        seekSlider.addEventListener('change', () => { socket.emit('seek', parseFloat(seekSlider.value)); isSeeking = false; });
    }

    // --- Socket Handlers ---
    socket.on('connect', () => {
        if(statusLight) statusLight.classList.add('connected');
        if(statusText) statusText.textContent = 'Ready';
    });
    socket.on('disconnect', () => {
        if(statusLight) statusLight.classList.remove('connected');
        if(statusText) statusText.textContent = 'Disconnected';
    });

    socket.on('servicesList', (services) => {
        if (services.tidal && services.tidal.connected) {
            if(tidalLoginContainer) tidalLoginContainer.classList.add('hidden');
            if(tidalConnectedInfo) tidalConnectedInfo.classList.remove('hidden');
        } else {
            if(tidalLoginContainer) tidalLoginContainer.classList.remove('hidden');
            if(tidalConnectedInfo) tidalConnectedInfo.classList.add('hidden');
        }
    });

    socket.on('statusUpdate', ({ status, currentSong }) => {
        lastStatusElapsed = parseFloat(status.elapsed || 0);
        lastStatusDuration = parseFloat(status.duration || 0);
        lastStatusTime = Date.now();
        
        if (status.state === 'play') {
            btnPlayPause.classList.add('playing');
            startTimer();
        } else {
            btnPlayPause.classList.remove('playing');
            clearInterval(playerTimer);
        }
        
        if (!isSeeking && seekSlider) {
            seekSlider.value = lastStatusElapsed;
            seekSlider.max = lastStatusDuration || 100;
            if(timeCurrent) timeCurrent.textContent = formatTime(lastStatusElapsed);
            if(timeDuration) timeDuration.textContent = formatTime(lastStatusDuration);
        }
        
        if(currentSong) {
            if(playerTitle) playerTitle.textContent = currentSong.title || path.basename(currentSong.file);
            if(playerArtist) playerArtist.textContent = currentSong.artist || 'Unknown';
            if(playerAlbum) playerAlbum.textContent = currentSong.album || 'Unknown';
        }
    });

    socket.on('queueList', (queue) => {
        const list = document.getElementById('queue-list');
        if(!list) return;
        list.innerHTML = '';
        queue.forEach(item => {
            const li = document.createElement('li');
            li.className = 'library-track';
            li.innerHTML = `<div class="track-info"><div class="track-title">${item.Title || item.file}</div></div>`;
            const btn = document.createElement('button');
            btn.className = 'icon-btn';
            btn.innerHTML = '&times;';
            btn.onclick = (e) => { e.stopPropagation(); socket.emit('removeFromQueue', item.Id); };
            li.appendChild(btn);
            list.appendChild(li);
        });
    });
    
    // System Info
    socket.on('systemInfo', (info) => {
        const osEl = document.getElementById('sys-os');
        const cpuEl = document.getElementById('sys-cpu');
        if(osEl) osEl.textContent = info.osVersion;
        if(cpuEl) cpuEl.textContent = `${info.cpuLoad}%`;
        if(settingsSpinner) settingsSpinner.classList.add('hidden');
    });

    // Library Lists
    socket.on('artistList', (list) => {
        if(!libraryViewArtists) return;
        libraryViewArtists.innerHTML = '';
        list.forEach(a => {
            const div = document.createElement('div');
            div.className = 'artist-item';
            div.innerHTML = `<span>${a}</span>`;
            div.onclick = () => { showLibraryView('albums'); socket.emit('getAlbums', a); };
            libraryViewArtists.appendChild(div);
        });
    });

    socket.on('albumList', ({artist, albums}) => {
        if(!libraryViewAlbums) return;
        libraryViewAlbums.innerHTML = '';
        albums.forEach(a => {
            const div = document.createElement('div');
            div.className = 'album-item';
            div.innerHTML = `<span>${a}</span>`;
            div.onclick = () => { showLibraryView('tracks'); socket.emit('getSongs', {artist, album: a}); };
            libraryViewAlbums.appendChild(div);
        });
    });

    socket.on('songList', ({songs}) => {
        if(!libraryViewTracks) return;
        libraryViewTracks.innerHTML = '';
        songs.forEach(s => {
            const li = document.createElement('li');
            li.className = 'library-track';
            li.innerHTML = `<div class="track-info"><div class="track-title">${s.title || s.file}</div></div>`;
            li.onclick = () => { socket.emit('clearQueue'); socket.emit('addToQueue', s.file); socket.emit('play'); closeModal(libraryModal); };
            libraryViewTracks.appendChild(li);
        });
    });

    // Initialize
    const ctx = visualizerCanvas ? visualizerCanvas.getContext('2d') : null;
    if(ctx) {
        // Simple visualizer loop placeholder
        const draw = () => {
            ctx.clearRect(0,0, visualizerCanvas.width, visualizerCanvas.height);
            ctx.fillStyle = '#e0b050';
            for(let i=0; i<20; i++) ctx.fillRect(i*15, 20 + Math.random()*20, 10, 40);
            requestAnimationFrame(draw);
        };
        draw();
    }
});